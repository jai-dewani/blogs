{"componentChunkName":"component---src-templates-blog-post-js","path":"/deffered-ienumerable/","result":{"data":{"site":{"siteMetadata":{"title":"Blogs by JaiD"}},"markdownRemark":{"id":"2dfcefc4-1198-56cf-bb41-370e7643cc10","excerpt":"Backstory While debugging a piece of C# code, we added a stopwatch to measure the performance of various code sections. For some reason, looping over a set of…","html":"<h2>Backstory</h2>\n<p>While debugging a piece of C# code, we added a stopwatch to measure the performance of various code sections. For some reason, looping over a set of elements took 50 seconds, whereas all the preprocessing just before looping over it took less than 0.1 seconds. After several hours of debugging (which was quite humbling), we discovered that the dataset was an IEnumerable. The 50 seconds were actually spent on preprocessing, but due to deferred execution, the stopwatch was showing the time taken to register the query rather than its actual execution. To learn why it happened, continue reading</p>\n<p>This blog is more for me than for you. Hopefully, five years from now, if I encounter the same issue, Google will recommend my own blog to me ☠️</p>\n<h2>What is Deferred Execution?</h2>\n<p>Deferred execution, also known as lazy evaluation, means that the evaluation of an expression is delayed until its result is actually required. In the context of IEnumerable, this means that when you define a query, it isn't executed immediately. Instead, the query is only executed when you iterate over the results.</p>\n<h2>How Deferred Execution Works</h2>\n<p>When you create a LINQ query or any other IEnumerable sequence, you're essentially creating a blueprint for how to obtain the data, not the data itself. The actual execution of this blueprint is postponed until you start iterating over the sequence.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> numbers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> evenNumbers <span class=\"token operator\">=</span> numbers<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// At this point, no filtering has actually occurred. In this example, evenNumbers is an IEnumerable that represents the concept of \"all even numbers in the list\". The Where method hasn't actually been called yet.</span></code></pre></div>\n<h2>Benefits of Deferred Execution</h2>\n<ul>\n<li><strong>Improved Performance:</strong> By delaying execution, you can avoid unnecessary computations. If you only need the first few elements of a large sequence, deferred execution allows you to stop processing once you have what you need.</li>\n<li><strong>Memory Efficiency:</strong> Since the entire result set doesn't need to be in memory at once, you can work with very large datasets more efficiently.</li>\n<li><strong>Composition:</strong> You can build complex queries by chaining multiple operations together without incurring the cost of multiple iterations over the data.</li>\n</ul>\n<h2>When is the Query Actually Executed?</h2>\n<p>The query is executed when:</p>\n<ul>\n<li>You iterate over the results using a <code class=\"language-text\">foreach</code> loop</li>\n<li>You call methods like <code class=\"language-text\">ToList()</code>, <code class=\"language-text\">ToArray()</code>, or <code class=\"language-text\">ToDictionary()</code></li>\n<li>You use operators like <code class=\"language-text\">First()</code>, <code class=\"language-text\">Last()</code>, or <code class=\"language-text\">Count()</code></li>\n</ul>\n<h2>Example of Deferred Execution</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> numbers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">List</span><span class=\"token operator\">&lt;</span>int<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> query <span class=\"token operator\">=</span> numbers<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">n</span> <span class=\"token operator\">=></span> n <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">n</span> <span class=\"token operator\">=></span> n <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nnumbers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// This will affect the query result</span>\n<span class=\"token function\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">var</span> num <span class=\"token keyword\">in</span> query</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Output: 6, 8, 10, 12</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In this example, even though we modified the numbers list after defining the query, the new element is included in the result. This is because the query isn't executed until the <code class=\"language-text\">foreach</code> loop.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> stopwatch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Stopwatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">IList<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> paragraph <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"This\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"is\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"program\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nstopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Timer started</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> waitingParagraph <span class=\"token operator\">=</span> paragraph<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span> <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    Thread<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Simulate some heavy processing</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Time taken - </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">stopwatch<span class=\"token punctuation\">.</span>Elapsed</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Around 00:00:00.0006335</span>\nstopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">Restart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Reset timer to 0</span>\n\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">in</span> waitingParagraph<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\"><span class=\"token keyword\">value</span></span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> \"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Output: This is a test program</span>\n<span class=\"token punctuation\">}</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Time taken - </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">stopwatch<span class=\"token punctuation\">.</span>Elapsed</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Around 00:00:02.6724506</span></code></pre></div>\n<p>In this example, even though we're using <code class=\"language-text\">Thread.Sleep</code> within the <code class=\"language-text\">.Select</code> projection, the processing isn't executed until we start iterating over all the elements one by one. As a result, the stopwatch shows that looping over the elements takes more than 2 seconds, but this is actually the time spent executing the <code class=\"language-text\">.Select</code> command for each element as it is requested.</p>\n<p>A fun use case for this could be creating a typing awareness animation by introducing randomness into the <code class=\"language-text\">Thread.Sleep</code> time to achieve the desired effect.</p>\n<p><img src=\"/blogs/aa0c5dc3f1d182579fb97ba0a45534e6/WindowsTerminal_U4dYkwMC6t-ezgif.com-resize.gif\" alt=\"typing awareness animation\"></p>\n<h2>Difference Between Deferred Execution in IEnumerable and a List in C#</h2>\n<p>Understanding the difference between IEnumerable and List in terms of execution is crucial for efficient C# programming. Here's a comparison:</p>\n<ul>\n<li><strong>Evaluation:</strong> IEnumerable uses deferred execution, while List executes immediately and stores all results in memory.</li>\n<li><strong>Memory:</strong> IEnumerable is memory efficient as it doesn’t store all elements in memory at once, whereas List does, making it more memory-intensive.</li>\n<li><strong>Performance:</strong> IEnumerable can be more performant when you don't need all elements at once, while List can be faster when you need repeated access to elements since the data is already in memory.</li>\n</ul>\n<p>Here's an example to illustrate the difference:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> numbers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// IEnumerable (deferred execution)</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> evenNumbersQuery <span class=\"token operator\">=</span> numbers<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// List (immediate execution)</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> evenNumbersList <span class=\"token operator\">=</span> numbers<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">=></span> n <span class=\"token operator\">%</span> <span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nnumbers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IEnumerable results:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> num <span class=\"token keyword\">in</span> evenNumbersQuery<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Output: 2, 4, 6</span>\n<span class=\"token punctuation\">}</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"List results:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> num <span class=\"token keyword\">in</span> evenNumbersList<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Output: 2, 4</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In this example, the IEnumerable query (<code class=\"language-text\">evenNumbersQuery</code>) includes the newly added number 6, while the List (<code class=\"language-text\">evenNumbersList</code>) does not, as it was evaluated before the addition.</p>\n<p>Choose between IEnumerable and List based on your specific use case, considering factors like data size, frequency of access, and whether you need a snapshot or the most up-to-date data.</p>\n<h2>Conclusion</h2>\n<p>99% of the time, I would have gotten away without knowing this, but it's for that 1% when not having a clear understanding of the platform or framework you work with can come back to bite you xD. It was a valuable learning experience, for sure!</p>","frontmatter":{"title":"IEnumerable execution is deferred","date":"August 30, 2024","description":"This is an interesting story about how the 1% of the time when you don't know what you're doing can come back to bite you. This is when I learned about the concept of deferred execution in C#, including its effects on performance, memory efficiency, and composition, as well as the differences between IEnumerable and List"}},"previous":{"fields":{"slug":"/one-stop-solution-to-sharing-your-resume/"},"frontmatter":{"title":"Your one stop solution to sharing your resume with everyone"}},"next":{"fields":{"slug":"/composition-over-inheritance-csharp/"},"frontmatter":{"title":"Is “Composition over Inheritance” Hard in C#?"}}},"pageContext":{"id":"2dfcefc4-1198-56cf-bb41-370e7643cc10","previousPostId":"9383e0a1-b1ad-51fc-874a-b732833087ea","nextPostId":"104acc39-52be-5550-b2b8-ce8109f3fe28"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}