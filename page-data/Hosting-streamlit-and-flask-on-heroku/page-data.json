{"componentChunkName":"component---src-templates-blog-post-js","path":"/Hosting-streamlit-and-flask-on-heroku/","result":{"data":{"site":{"siteMetadata":{"title":"Blogs by JaiD"}},"markdownRemark":{"id":"967a2e42-707b-5432-ae00-81bde7f22653","excerpt":"In this blog I will be covering the steps I took to host my project 'DeepNeuralNetwork' on Heroku. I used Flask to power a keras model and serve its output asâ€¦","html":"<p>In this blog I will be covering the steps I took to host my project '<a href=\"https://github.com/jai-dewani/DeepNeural-Net-Visualiser\">DeepNeuralNetwork</a>' on Heroku. I used Flask to power a keras model and serve its output as an API which I consumed using streamlit while create responsive, fast and clean UI</p>\n<h1>A bit about Heroku</h1>\n<p>Everying in Heroku is an <strong>app</strong> which can be deoployed to <strong><a href=\"https://www.heroku.com/dynos\">dyons</a></strong> which are basically light weight linux containers which can host your app It uses container-based architecture to host apps, which means you can easily scale up your apps by increase the number of containers to balance out the load!<br>\nWhen you sign up with Heroku, you automatically get some free dyno hours, a sort of currency which can be used to run your apps in dynos. When your app runs, it consumes dyno hours. And when your app is idle for 30 minutes or more it automatically sleeps to stop consuming dyno hours. Don't worry it will take up automatically if you give it any task to do (might take a few seconds to warm up)</p>\n<p>They also provide a free tier service and its main features are:</p>\n<ul>\n<li>550 Hours of dyno hours per month</li>\n<li>After adding a credit card you will get +450 hours per month</li>\n<li>Your monthly dyno hours can be shared by two or more apps</li>\n<li>1 dyno per app</li>\n<li>512 MB ram per dyno, which will be used to load all the extra packages you will be installing (This information will be useful afterwards).</li>\n<li>Upto 5 free apps (without credit card) or 100 (with credit card)</li>\n</ul>\n<p><em>I'll be referring terminal on Linux/Mac and cmd on windows as terminal, so that is easy for me</em></p>\n<h1>Setting up Heroku CLI</h1>\n<p>I am assuming that you have made an account on Heroku.</p>\n<p>Before starting any sort of deployment you need to setup Heroku cli to be able to push your code directly to Heroku from <a href=\"https://devcenter.heroku.com/articles/heroku-cli#download-and-install\">here</a> after downloading and installing Heroku cli, open your terminal/cmd and type</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">heroku login</code></pre></div>\n<p>which should promote you to login to Heroku on a browser, after successfully loging in you shoud something like</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Logging in... done\nLogged in as me@example.com</code></pre></div>\n<p>on your terminal. This means you have completed the 1<sup>st</sup> step of learning to host on Heroku</p>\n<h1>Hosting flask + keras model</h1>\n<p>You will mainly need the following files to host your application on Heroku</p>\n<ul>\n<li>app.py (core logic of your app)</li>\n<li>Procfile</li>\n<li>runtime.txt</li>\n<li>requirements.txt</li>\n</ul>\n<p>After which you will have to do the following steps</p>\n<ul>\n<li>Create an Heroku app</li>\n<li>Pushing your code to Heroku's server</li>\n</ul>\n<h3>Create your flask app</h3>\n<p>Mine loads a pre-trained model using a .h5 file and serves its outputs over an API. All the code snipits in this section are part of a same file <em>app.py</em> in the order given bellow</p>\n<ul>\n<li>Importing all the necessary stuff</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import json\nimport tensorflow as tf \nimport numpy as np \nimport random \nfrom flask import Flask, request</code></pre></div>\n<ul>\n<li>Loading my pre-trained MNSIT model from <em>model.h5</em></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">model = tf.keras.models.load_model('model.h5')\nfeature_model = tf.keras.models.Model(\n\tmodel.inputs,\n\t[layer.output for layer in model.layers]\n)\n_, (x_test, _ ) = tf.keras.datasets.mnist.load_data()\nx_test = x_test/255\ndef get_prediction():\n\tindex = np.random.choice(x_test.shape[0])\n\timage = x_test[index, :, :]\n\timage_arr = np.reshape(image, (1, 784))\n\treturn feature_model.predict(image_arr), image</code></pre></div>\n<ul>\n<li>Using flask to create a API which serves values from each node of different layers in my model</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">app = Flask(__name__)\n@app.route('/', methods=['GET','POST'])\ndef index():\n    if request.method == \"POST\":\n        preds, image = get_prediction()\n        final_preds = [p.tolist() for p in preds]\n        return json.dumps({\n            'prediction': final_preds,\n            'image': image.tolist()\n        })\n    return \"Welcome to Neural Network Visualization\"\nif __name__==\"__main__\":\n    app.run()</code></pre></div>\n<h3>Create <em>Procfile</em></h3>\n<p>Yes it has no extensions, so avoid adding any. The <code class=\"language-text\">Procfile</code> is used by Heroku's dynos to understand what commands are to be run on start up of application.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">web:gunicorn app:app</code></pre></div>\n<p>The second part of the statment <code class=\"language-text\">app:app</code> specifies that the app file has to be run. Suppose if the name of main file would have been <code class=\"language-text\">index.py</code> we would have insted wrote</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">web:gunirn index:app</code></pre></div>\n<h3>Create a <em>runtime.txt</em></h3>\n<p>This file is used to specify the python version we will be using in this dyno.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">python-3.7.6</code></pre></div>\n<h3>Create a <em>requirements.txt</em></h3>\n<p>It is used to store the pip modules that you have used and should be installed on your dyno to run your app smoothly. Don't worry if you haven't written the exact version of your pip modules, just the name should be enough, Heroku will install the latest version matching that name.<br>\nAn example of my <code class=\"language-text\">requirements.txt</code> is</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tensorflow==1.14.0 \nnumpy==1.18.1\njson5==0.9.1\nFlask==1.1.1\ngunicorn</code></pre></div>\n<p><strong>Notice:</strong> that I am using an old version of tensorflow 1.14.0 insted of latest ones 2.x.x because <strong>size wise the latest tensorflow package is above 500 MB</strong> which results in <code class=\"language-text\">slug size too large</code> errors while hosting your application on Heroku as the max size of application Heroku can allows is 500MB. Better to keep that in mind while creating your new app!</p>\n<h3>Run the following commands which will create an app in your Heroku account</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">heroku create &lt;your-app-name></code></pre></div>\n<h3>Run the following commands to push your code to Heroku server</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git init \ngit add .\ngit commit -m \"&lt;your-message>\ngit push heroku master</code></pre></div>\n<p>Congrats your Flask app is hosted on Heroku :tada:! You can now view your app on Heroku's dashboard and change its settings from there</p>\n<h3>To Open your app on browser via terminal</h3>\n<p>Make sure you are on the root folder of your app</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">heroku open</code></pre></div>\n<h1>Hosting Streamlit to Heroku</h1>\n<p>You will mainly need the following files to host your streamlit application on Heroku</p>\n<ul>\n<li>app.py (core logic of your app)</li>\n<li>Procfile</li>\n<li>requirements.txt</li>\n<li>setup.sh</li>\n</ul>\n<p>After which you will have to do the following steps</p>\n<ul>\n<li>Create an Heroku app</li>\n<li>Pushing your code to Heroku's server</li>\n</ul>\n<h3>Creating your streamlit App</h3>\n<p>Creating a streamlit app is quite simple as it emphasises and primarily used on python scripting behaviour. They also have cool demos you can build while learing on their <a href=\"streamlit.io\">website</a><br>\nMy Streamlit application looks something like this</p>\n<ul>\n<li>Importing all my stuff</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import streamlit as st\nimport json\nimport requests\nimport matplotlib.pyplot as plt\nfrom matplotlib.patches import Circle\nimport numpy as np </code></pre></div>\n<ul>\n<li>Decplring the URL of my server (you might wanna fill it with url of your own server)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># Url of your Flask server\nURL = '' </code></pre></div>\n<ul>\n<li>Adding a title to my page and a sidebar where I will show my image</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">st.title('Neural Network Visualizer')\nst.sidebar.markdown('## Input Image')</code></pre></div>\n<ul>\n<li>If the button 'Get random predicition' is clicked' the following code section inside if-statment will run.</li>\n</ul>\n<p>Which sends a post request to the URL collects it output, reshapes the image to a square size and adds it to the side bar. The for loop creats a graphical view from the values of each nodes in different layers and plots it in the end</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">if st.button('Get random prediction'):\n        response = requests.post(URL, data={})\n        response = json.loads(response.text)\n        preds = response.get('prediction')\n        image = response.get('image')\n        image = np.reshape(image, (28,28))\n        st.sidebar.image(image, width=150)\n        # print(preds)\n        for layer, p in enumerate(preds):\n                # print(layer,p)\n                numbers = np.squeeze(np.array(p))\n                plt.figure(figsize=(32,6))\n                if layer == 2:\n                        row = 1\n                        col = 10\n                else:\n                        row = 2\n                        col = 16\n                for i, number in enumerate(numbers):\n                        plt.subplot(row,col,i+1)\n                        plt.imshow(number * np.ones((8,8,3)).astype('float32'))\n                        plt.xticks([])\n                        plt.yticks([])\n                        if layer == 2:\n                                plt.xlabel(str(i), fontsize=40)\n                plt.subplots_adjust(wspace=0.05, hspace=0.05)\n                plt.tight_layout()\n                st.text('Layer {}'.format(layer+1))\n                st.pyplot()</code></pre></div>\n<h3>Creating a <em>Procfile</em></h3>\n<p>Make sure to now add any extensions like '.txt' while creating the file. Here we are telling the dyno to first run our setup.sh file (which we will be creating after this) and start our streamlit server after that. Streamlit servers are started with the command <code class=\"language-text\">streamlit run &lt;filename></code></p>\n<h3>Procfile:</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">web: sh setup.sh &amp;&amp; streamlit run app.py</code></pre></div>\n<h3>Creating a <em>setup.sh</em> file</h3>\n<p>It helps us to create the necessary changes in the environment for our streamlit app to run smoothly</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">echo \"\\\n[server]\\n\\\nheadless = true\\n\\\nport = $PORT\\n\\\nenableCORS = false\\n\\\n\\n\\\n\" > ~/.streamlit/config.toml</code></pre></div>\n<h3>Creating a <em>requirements.txt</em></h3>\n<p>It is used to store the pip modules that you have used and should be installed on your dyno to run your app smoothly. Heroku will automatically install all the pip modules written in this file. Don't worry if you haven't written the exact version of your pip modules, just the name should be enough, Heroku will install the latest version matching that name. An example of my <code class=\"language-text\">requirements.txt</code> is</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">numpy==1.18.1\njson5==0.9.1\njsonschema==3.2.0\nstreamlit==0.61.0\nmatplotlib==3.1.3</code></pre></div>\n<h3>Creating an App on Heroku</h3>\n<blockquote>\n<p>I am assuming you have installed <em>heroku cli</em> and logged in using <em>heroku login</em>, if not follow the step given in the starting of this tutorial to setup Heroku cli and login using your account.</p>\n</blockquote>\n<p>Create your app on Heroku by typing</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">heroku create &lt;your-app-name></code></pre></div>\n<h3>Run the following commands to push your code to Heroku server</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git init \ngit add .\ngit commit -m \"&lt;your-message>\ngit push heroku master</code></pre></div>\n<p>Congrats your Streamlit app is now hosted on Heroku :tada:! You can now view your app on Heroku's daskboard and change its settings from there</p>\n<h3>To Open your app on browser via terminal</h3>\n<p>Make sure you are on the root folder of your app and run</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">heroku open</code></pre></div>\n<hr>\n<p>Hope this helped you in hosting your Flask and Streamlit app on Heroku. Consider checking out my <a href=\"https://github.com/jai-dewani/DeepNeural-Net-Visualiser\">Github Repo</a> which contains all the code which was talked about in this tutorial</p>","frontmatter":{"title":"Hosting my Flask and Streamlit application on free tier Heroku","date":"June 28, 2020","description":"In this blog I will be discussing the steps I followed to host my application 'DeepNeuralNetwork' on free tier Heroku which uses Flask to run a keras model and serves an API and streamlit to create clean, fast and responsive UI"}},"previous":{"fields":{"slug":"/hashcode-2020/"},"frontmatter":{"title":"HashCode 2020 Experience and how to approach it for the first time"}},"next":{"fields":{"slug":"/Interviews-are-fun/"},"frontmatter":{"title":"Interviews are FUN"}}},"pageContext":{"id":"967a2e42-707b-5432-ae00-81bde7f22653","previousPostId":"c40f0fbe-01b1-551c-898f-22f36e601428","nextPostId":"70de3707-4ced-51f1-8070-756d41200ebb"}},"staticQueryHashes":["2841359383","3257411868"],"slicesMap":{}}